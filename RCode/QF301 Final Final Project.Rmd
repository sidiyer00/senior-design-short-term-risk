---
title: "Data Gathering"
author: "Marc Vitenzon"
date: "11/14/2021"
output: pdf_document
---

```{r, warning=F, message=F}
library(quantmod)

symbols <- c("SPY", "VXX")
getSymbols(symbols, from="2018-01-25", to="2021-01-01")

price_data = data.frame(SPY$SPY.Adjusted,VXX$VXX.Adjusted)
colnames(price_data) <- symbols

```

```{r}
library(TTR)

# all indicators related to the SPY
sma = as.numeric(SMA(price_data[,1]))
cci = as.numeric(CCI(price_data[,1]))
cmo = as.numeric(CMO(price_data[,1]))
macd = as.numeric(MACD(price_data[,1])[,1])
bbands = as.numeric(BBands(price_data[,1])[,4])
runSum = as.numeric(runSum(price_data[,1]))
fastK= as.numeric(stoch(price_data[,1])[,1])
fastD = as.numeric(stoch(price_data[,1])[,2])
slowD = as.numeric(stoch(price_data[,1])[,3])
tdi = as.numeric(TDI(price_data[,1])[,1])
trix = as.numeric(TRIX(price_data[,1])[,1])
volatility = as.numeric(volatility(price_data[,1]))
wpr = as.numeric(WPR(price_data[,1]))
zigZag = as.numeric(ZigZag(price_data[,1]))

# VXX daily returns
vxxReturns = dailyReturn(VXX, type="log")

indicator_df = data.frame(
  sma,
  cci,
  cmo,
  macd,
  bbands,
  fastK,
  fastD,
  slowD,
  tdi,
  trix,
  volatility
)

indicator_df = indicator_df[complete.cases(indicator_df), ] # not lagged or logs


library(corrplot)
corrplot(cor(indicator_df, use = "complete.obs"), method = "number")

#% change df
```

```{r}
library(TTR)

# all indicators related to the SPY
sma = as.numeric(SMA(price_data[,1]))
cci = as.numeric(CCI(price_data[,1]))
cmo = as.numeric(CMO(price_data[,1]))
macd = as.numeric(MACD(price_data[,1])[,1])
bbands = as.numeric(BBands(price_data[,1])[,4])
runSum = as.numeric(runSum(price_data[,1]))
fastK= as.numeric(stoch(price_data[,1])[,1])
fastD = as.numeric(stoch(price_data[,1])[,2])
slowD = as.numeric(stoch(price_data[,1])[,3])
tdi = as.numeric(TDI(price_data[,1])[,1])
trix = as.numeric(TRIX(price_data[,1])[,1])
volatility = as.numeric(volatility(price_data[,1]))
wpr = as.numeric(WPR(price_data[,1]))
zigZag = as.numeric(ZigZag(price_data[,1]))

# VXX daily returns
vxxReturns = dailyReturn(VXX, type="log")

indicator_df = data.frame(
  sma,
  cci,
  cmo,
  macd,
  bbands,
  fastK,
  fastD,
  slowD,
  tdi,
  trix,
  volatility
)

indicator_df = indicator_df[complete.cases(indicator_df), ] # not lagged or logs


library(corrplot)
corrplot(cor(indicator_df, use = "complete.obs"), method = "number")

indicator_df2 = data.frame(
  Delt(sma,type='arithmetic'),
  Delt(cci,type='arithmetic'),
  Delt(cmo,type='arithmetic'),
  Delt(macd,type='arithmetic'),
  Delt(bbands,type='arithmetic'),
  Delt(fastK,type='arithmetic'),
  Delt(fastD,type='arithmetic'),
  Delt(slowD,type='arithmetic'),
  Delt(tdi,type='arithmetic'),
  Delt(trix,type='arithmetic'),
  Delt(volatility,type='arithmetic')
)
colnames(indicator_df2) <- c("sma", 'cci', 'cmo', 'macd', 'bbands', 'fastK', 'fastD', 'slowD', 'tdi', 'trix', 'volatility')
rownames(indicator_df2) <- rownames(price_data)
nrow(vxxReturns)
nrow(indicator_df2)
#View(vxxReturns)
#View(indicator_df2)
###########################################################################################################################
### This modifies the lag of the model - change 7 to what you want the lag to be, and change 6 to your desired lag - 1 on the next line
#############################################################################
indicator_df2 <- indicator_df2[7:nrow(indicator_df2),]
indicator_df2$vxxReturns <-  vxxReturns[1:(nrow(vxxReturns)-6),]
indicator_df2 <- na.omit(indicator_df2)
indicator_df2 <- indicator_df2[!is.infinite(rowSums(indicator_df2)),]

#View(indicator_df2) 
#indicator_df2 = indicator_df2[-na.omit(indicator_df2), ]

```

```{r}
train=sample(length(indicator_df2),length(indicator_df2)*.8,replace=FALSE) #Train/Test split

library(glmnet)

lin.mod = glm(indicator_df2$vxxReturns~.,data=indicator_df2,subset=train)
summary(lin.mod)

lin.pred=predict(lin.mod,indicator_df2[-train,])
mean((lin.pred-indicator_df2$vxxReturns[-train])^2)

```
```{r}
train=sample(length(indicator_df2),length(indicator_df2)*.8,replace=FALSE) #Train/Test split

library(glmnet)

lin.mod = glm(indicator_df2$vxxReturns~.,data=indicator_df2,subset=train)
summary(lin.mod)

lin.pred=predict(lin.mod,indicator_df2[-train,])
mean((lin.pred-indicator_df2$vxxReturns[-train])^2)

```

```{r}
library(tree)
tree.reg = tree(indicator_df2$vxxReturns~.,data=indicator_df2,subset=train)


mean((indicator_df2$vxxReturns[train] - predict(tree.reg, indicator_df2[train,]))^2) #Training MSE

y.tree.pred = predict(tree.reg, indicator_df2[-train,]) # Predict with the single regression tree
tree.MSE = mean((indicator_df2$vxxReturns[-train] - y.tree.pred)^2)
tree.MSE #Test MSE

```
```{r}
library(randomForest)

rf.reg = randomForest(indicator_df2$vxxReturns~.,data=indicator_df2,subset=train,mtry=3,ntree=300,importance=TRUE)
rf.reg #Gives both the number of variables at each split but also provides out-of-bag estimate of error rate

mean((indicator_df2$vxxReturns[train] - predict(rf.reg, indicator_df2[train,]))^2)

y.rf.pred = predict(rf.reg, indicator_df2[-train,]) # Predict with bagging
rf.MSE = mean((indicator_df2$vxxReturns[-train] - y.rf.pred)^2)
rf.MSE


```

```{r}
getSymbols(symbols, from="2021-01-02", to="2021-11-30")

price_data = data.frame(SPY$SPY.Adjusted,VXX$VXX.Adjusted)
colnames(price_data) <- symbols

# all indicators related to the SPY
sma = as.numeric(SMA(price_data[,1]))
cci = as.numeric(CCI(price_data[,1]))
cmo = as.numeric(CMO(price_data[,1]))
macd = as.numeric(MACD(price_data[,1])[,1])
bbands = as.numeric(BBands(price_data[,1])[,4])
runSum = as.numeric(runSum(price_data[,1]))
fastK= as.numeric(stoch(price_data[,1])[,1])
fastD = as.numeric(stoch(price_data[,1])[,2])
slowD = as.numeric(stoch(price_data[,1])[,3])
tdi = as.numeric(TDI(price_data[,1])[,1])
trix = as.numeric(TRIX(price_data[,1])[,1])
volatility = as.numeric(volatility(price_data[,1]))
wpr = as.numeric(WPR(price_data[,1]))
zigZag = as.numeric(ZigZag(price_data[,1]))

# VXX daily returns
vxxReturns = dailyReturn(VXX, type="log")

indicator_df = data.frame(
  sma,
  cci,
  cmo,
  macd,
  bbands,
  fastK,
  fastD,
  slowD,
  tdi,
  trix,
  volatility
)

indicator_df = indicator_df[complete.cases(indicator_df), ] # not lagged or logs

# all indicators related to the SPY
sma = as.numeric(SMA(price_data[,1]))
cci = as.numeric(CCI(price_data[,1]))
cmo = as.numeric(CMO(price_data[,1]))
macd = as.numeric(MACD(price_data[,1])[,1])
bbands = as.numeric(BBands(price_data[,1])[,4])
runSum = as.numeric(runSum(price_data[,1]))
fastK= as.numeric(stoch(price_data[,1])[,1])
fastD = as.numeric(stoch(price_data[,1])[,2])
slowD = as.numeric(stoch(price_data[,1])[,3])
tdi = as.numeric(TDI(price_data[,1])[,1])
trix = as.numeric(TRIX(price_data[,1])[,1])
volatility = as.numeric(volatility(price_data[,1]))
wpr = as.numeric(WPR(price_data[,1]))
zigZag = as.numeric(ZigZag(price_data[,1]))



indicator_df2 = data.frame(
  Delt(sma,type='arithmetic'),
  Delt(cci,type='arithmetic'),
  Delt(cmo,type='arithmetic'),
  Delt(macd,type='arithmetic'),
  Delt(bbands,type='arithmetic'),
  Delt(fastK,type='arithmetic'),
  Delt(fastD,type='arithmetic'),
  Delt(slowD,type='arithmetic'),
  Delt(tdi,type='arithmetic'),
  Delt(trix,type='arithmetic'),
  Delt(volatility,type='arithmetic')
)
colnames(indicator_df2) <- c("sma", 'cci', 'cmo', 'macd', 'bbands', 'fastK', 'fastD', 'slowD', 'tdi', 'trix', 'volatility')
rownames(indicator_df2) <- rownames(price_data)

indicator_df2 <- indicator_df2[7:nrow(indicator_df2),]
indicator_df2$vxxReturns <-  vxxReturns[1:(nrow(vxxReturns)-6),]
indicator_df2 <- na.omit(indicator_df2)
indicator_df2 <- indicator_df2[!is.infinite(rowSums(indicator_df2)),]

y.rf.pred = predict(rf.reg, indicator_df2) 

result <- data.frame(y.rf.pred)



result$direction <- (result$y.rf.pred >0) +0
result$date <- rownames(result)
vol_expected <- data.frame(result[which(result$direction == 1),])
vol_expected$date <- as.Date(rownames(vol_expected))

###########################################################################################################################
### This modifies for how far out you begin to go risk-off after the signal is triggered. Ex: 5 means 5 days after the signal is triggered go risk off
#############################################################################
for (i in 1:nrow(vol_expected)){
  vol_expected$date[i] <- vol_expected$date[i]+5
}


price_data$date <- rownames(price_data)
price_data$VXX_direction_pred <- 0

for(i in 1:nrow(price_data)){
  for (j in 1: nrow(vol_expected)){
    if(price_data$date[i] == vol_expected$date[j]){
    price_data$VXX_direction_pred[i] <- 1
    }
  }
}

price_data$port <- 100
price_data$spy_port <- 100

###########################################################################################################################
### This modifies for how many days the model goes risk-off once the signal gets triggered, change 5 to your desired period
#############################################################################
counter = 0;
for(i in 1:nrow(price_data)){
  if (i != nrow(price_data)){
  if(price_data$VXX_direction_pred[i] == 1){
    if (counter != 6){
      price_data$VXX_direction_pred[i+1] <- 1
      counter = counter + 1
    } else {
      counter = 0
      price_data$VXX_direction_pred[i+1] <- 0
    }
  }
  }
}

price_data$spy_ret <- dailyReturn(SPY$SPY.Adjusted, type = "arithmetic")
price_data$port_ret <- dailyReturn(SPY$SPY.Adjusted, type = "arithmetic")


for(i in 1:nrow(price_data)){
  if(price_data$VXX_direction_pred[i] == 1){
    price_data$port_ret[i] <- 0
  }
}



for(i in 2:nrow(price_data)){
  price_data$spy_port[i] <- price_data$spy_port[i-1] * (1+price_data$spy_ret[i-1])
  price_data$port[i] <- price_data$port[i-1] * (1+price_data$port_ret[i-1])
}


final_result <- cbind(price_data$port,price_data$spy_port)
rownames(final_result) <- rownames(price_data)
colnames(final_result) <- c("Portfolio Return", "SPY Return")
rownames(final_result) <- rownames(price_data)
final_result <- data.frame(final_result)
final_result$date <- as.Date(rownames(final_result))

sharpe_ratios <- data.frame(as.matrix(0,2,2))
sharpe_ratios$as.matrix.0..2..2.[1] <- (mean(price_data$port_ret))/sd(price_data$port_ret)
sharpe_ratios$as.matrix.0..2..3.[1] <-(mean(price_data$spy_ret))/sd(price_data$spy_ret)
colnames(sharpe_ratios) <- c("Portfolio Daily Sharpe", "SPY Daily Sharpe")
View(sharpe_ratios)


library(ggplot2)
library(reshape2)


final_result <- melt(final_result, id = "date")


ggplot(final_result, aes(x = final_result$date, y = final_result$value, color = variable, group = final_result$variable))+geom_line()+ scale_x_date(date_minor_breaks = "1 day") + labs(color = "Portfolio") + xlab("Date") + ylab("Portfolio Value") + ggtitle("Model Performance vs. SPY") 




```

